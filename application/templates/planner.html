{% extends "base.html" %}

{% block title %}Финансовый планировщик{% endblock %}

{% block content %}
<h1 class="text-center">Финансовый планировщик</h1>

<div class="row">
    <div class="col-md-6">
        <h2>Добавить доход</h2>
        <form method="post">
            {{ income_form.hidden_tag() }}
            <input type="hidden" name="form_name" value="income_form">
            <div class="form-group">
                {{ income_form.amount.label }}
                {{ income_form.amount(class="form-control") }}
            </div>
            <div class="form-group">
                {{ income_form.date.label }}
                {{ income_form.date(class="form-control") }}
            </div>
            <div class="form-group">
                {{ income_form.category.label }}
                {{ income_form.category(class="form-control") }}
            </div>
            {{ income_form.submit(class="btn btn-primary") }}
        </form>
    </div>

    <div class="col-md-6">
        <h2>Добавить расход</h2>
        <form method="post">
            {{ expense_form.hidden_tag() }}
            <input type="hidden" name="form_name" value="expense_form">
            <div class="form-group">
                {{ expense_form.amount.label }}
                {{ expense_form.amount(class="form-control") }}
            </div>
            <div class="form-group">
                {{ expense_form.date.label }}
                {{ expense_form.date(class="form-control") }}
            </div>
            <div class="form-group">
                {{ expense_form.category.label }}
                {{ expense_form.category(class="form-control") }}
            </div>
            {{ expense_form.submit(class="btn btn-primary") }}
        </form>
    </div>
</div>

<h2 class="mt-5">Соотношение доходов и расходов</h2>
<div id="mainChart" style="width: 700px; height: 500px; margin: auto;"></div>

<div id="detailChartContainer" style="display: none;">
    <button class="btn btn-secondary mb-3" onclick="showMainChart()">Назад</button>
    <div id="detailChart" style="width: 700px; height: 500px; margin: auto;"></div>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {packages: ['corechart']});
    google.charts.setOnLoadCallback(drawMainChart);

    const incomeData = {{ income_data|tojson }};
    const expenseData = {{ expense_data|tojson }};
    const incomeCategories = {{ income_categories|tojson }};
    const expenseCategories = {{ expense_categories|tojson }};

    function drawMainChart() {
        const data = google.visualization.arrayToDataTable([
            ['Тип', 'Сумма'],
            ['Доходы', incomeData.reduce((a, b) => a + b, 0)],
            ['Расходы', expenseData.reduce((a, b) => a + b, 0)]
        ]);

        const options = {
            title: 'Соотношение доходов и расходов',
            pieHole: 0.4,
            colors: ['#4bc0c0', '#ff6384'],
            chartArea: {width: '90%', height: '90%'}
        };

        const chart = new google.visualization.PieChart(document.getElementById('mainChart'));

        google.visualization.events.addListener(chart, 'select', function () {
            const selectedItem = chart.getSelection()[0];
            if (selectedItem) {
                const type = data.getValue(selectedItem.row, 0);
                if (type === 'Доходы') {
                    drawDetailChart('Доходы', incomeCategories);
                } else if (type === 'Расходы') {
                    drawDetailChart('Расходы', expenseCategories);
                }
            }
        });

        chart.draw(data, options);
    }

    function drawDetailChart(type, categories) {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Категория');
        data.addColumn('number', 'Сумма');
        categories.forEach(category => data.addRow([category.name, category.amount]));

        const options = {
            title: `Распределение ${type.toLowerCase()} по категориям`,
            pieHole: 0.4,
            colors: ['#4bc0c0', '#36a2eb', '#9966ff', '#ffcd56', '#ff6384'],
            chartArea: {width: '90%', height: '90%'}
        };

        const chart = new google.visualization.PieChart(document.getElementById('detailChart'));

        document.getElementById('mainChart').style.display = 'none';
        document.getElementById('detailChartContainer').style.display = 'block';

        chart.draw(data, options);
    }

    function showMainChart() {
        document.getElementById('mainChart').style.display = 'block';
        document.getElementById('detailChartContainer').style.display = 'none';
    }
</script>
{% endblock %}
